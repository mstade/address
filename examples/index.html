<!doctype html>
<nav class="menu">
  <h1>address examples</h1>
  <ul>
    <li><a href="#/greeting/world">Greeting world</a></li>
      <li><a href="#/greeting">Greeting anonymous</a></li>
  </ul>
</nav>
<div id="root" class="z-app"></div>

<style>
</style>

<script src="../node_modules/underscore/underscore.js"></script>
<script src="../node_modules/d3-dispatch/build/d3-dispatch.js"></script>
<script src="../node_modules/@websdk/rhumb/lib/rhumb.js"></script>
<script src="../node_modules/@websdk/nap/lib/nap.js"></script>
<script src="../lib/address.js"></script>

<script>
  var web = nap.web()
  var routes = rhumb.create()

  web.find = function (uri) {
    return routes.match(uri)
  }

  defineResources(nap.negotiate, function() {
    address.location.basePath('examples/#')
    address.location.on('statechange', load)

    load(address.location.getState())
  })

  function greeting (req, res) {
    res(null, address.ok(view))

    function view(node) {
      node.innerHTML = '<header><h2><span>Hello </span><span class="js-name"></span></h2></header>'

      var nameElements = node.getElementsByClassName('js-name')

      nameElements[0].textContent = req.params.name || 'anonymous'
    }
  }

  function redirectHome (req, res) {
    res(null, address.redirect('/greeting'))
  }

  function defineResources(negotiate, callback) {
    routes.add('/examples', routeDefinition('home (redirect)', '/examples', ['get']))
    routes.add('/greeting(/{name})', routeDefinition('greeting', '/greeting(/{name})', ['get']))

    web.resource('home (redirect)', '/examples', negotiate.method({ get: negotiate.accept({ 'application/x.nap.view': redirectHome }) }))
    web.resource('greeting', '/greeting(/{name})', negotiate.method({ get: negotiate.accept({ 'application/x.nap.view': greeting }) }))

    callback()
  }

  function routeDefinition (name, path, methods) {
    return function (params) {
      return {
        name: name
      , path: path
      , methods: methods
      , params: params
      , redirects: []
      }
    }
  }

  function load(path) {
    if(!path) return onError({ statusCode: 404 })

    address.address(path).web(web)
      .on('redirection', onRedirect)
      .on('client-error', onError)
      .into()
      .get()

    function onError(res) {
      console.debug({ statusCode: res.statusCode, path: path })
    }

    function onRedirect(res) {
      load(res.headers.location)
    }
  }
</script>
